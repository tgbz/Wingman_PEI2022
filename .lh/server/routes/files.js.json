{
    "sourceFile": "server/routes/files.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1674126099496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1674126287818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -54,19 +54,20 @@\n   // console.log(__dirname + '/../files/avatar/' + req.params.id + '.jpeg')\r\n   const testFolder = __dirname + \"/../files/avatar/\";\r\n   const fs = require(\"fs\");\r\n   fs.readdir(testFolder, (err, files) => {\r\n-    try {\r\n+    if (files) {\r\n       files.forEach((file) => {\r\n         if (file.split(\".\")[0] == req.params.id) {\r\n           console.log(\"Encontrei: \" + file);\r\n           res.sendFile(path.join(__dirname + \"/../files/avatar/\" + file));\r\n         }\r\n-      });\r\n-    } catch (err) {\r\n+      })\r\n+    }\r\n+    else {\r\n       console.log(err);\r\n       res.jsonp(\"Ficheiro não encontrado\");\r\n     }\r\n+    }\r\n   });\r\n-});\r\n \r\n module.exports = router;\r\n"
                },
                {
                    "date": 1674126343718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,14 +60,13 @@\n         if (file.split(\".\")[0] == req.params.id) {\r\n           console.log(\"Encontrei: \" + file);\r\n           res.sendFile(path.join(__dirname + \"/../files/avatar/\" + file));\r\n         }\r\n-      })\r\n-    }\r\n-    else {\r\n+      });\r\n+    } else {\r\n       console.log(err);\r\n       res.jsonp(\"Ficheiro não encontrado\");\r\n     }\r\n-    }\r\n   });\r\n+});\r\n \r\n module.exports = router;\r\n"
                },
                {
                    "date": 1674126567194,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -54,18 +54,17 @@\n   // console.log(__dirname + '/../files/avatar/' + req.params.id + '.jpeg')\r\n   const testFolder = __dirname + \"/../files/avatar/\";\r\n   const fs = require(\"fs\");\r\n   fs.readdir(testFolder, (err, files) => {\r\n-    if (files) {\r\n+    if (err) {\r\n+      console.log(err);\r\n+    } else {\r\n       files.forEach((file) => {\r\n         if (file.split(\".\")[0] == req.params.id) {\r\n           console.log(\"Encontrei: \" + file);\r\n           res.sendFile(path.join(__dirname + \"/../files/avatar/\" + file));\r\n         }\r\n       });\r\n-    } else {\r\n-      console.log(err);\r\n-      res.jsonp(\"Ficheiro não encontrado\");\r\n     }\r\n   });\r\n });\r\n \r\n"
                }
            ],
            "date": 1674126099496,
            "name": "Commit-0",
            "content": "var express = require(\"express\");\r\nvar router = express.Router();\r\nvar sql = require(\"../config/database.js\");\r\nvar passport = require(\"passport\");\r\nconst multer = require(\"multer\");\r\nvar path = require(\"path\");\r\nconst fs = require(\"fs\");\r\nconst upload = multer({\r\n  dest: \"uploads/\", // this saves your file into a directory called \"uploads\"\r\n});\r\n\r\nrouter.post(\"/avatar/\", upload.single(\"avatarFile\"), function (req, res, next) {\r\n  //console.log(req.file)\r\n  //console.log(req.body)\r\n  let file = req.file;\r\n  let oldPath = __dirname + \"/../\" + file.path;\r\n  let newPath = __dirname + \"/../files/avatar/\";\r\n  let id = req.body.user;\r\n\r\n  // verificar se já existe um ficheiro com o mesmo nome, mesmo que tenha extensões diferentes\r\n  fs.readdir(newPath, (err, files) => {\r\n    if (err) {\r\n      console.log(err);\r\n    } else {\r\n      files.forEach((file) => {\r\n        if (file.split(\".\")[0] == id) {\r\n          console.log(\"file already exists: \" + file + \" deleting...\");\r\n          fs.unlink(newPath, (err) => {\r\n            if (err) {\r\n              console.log(err);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  newPath = newPath + id + \".\" + file.mimetype.split(\"/\")[1];\r\n  console.log(newPath);\r\n  console.log(oldPath);\r\n\r\n  fs.copyFile(oldPath, newPath, function (err) {\r\n    if (err) {\r\n      console.log(err);\r\n    }\r\n    //console.log('RRR')\r\n    fs.unlinkSync(oldPath);\r\n    res.jsonp(\"Ficheiro gravado com sucesso!\");\r\n    // Mudar para status\r\n  });\r\n});\r\n\r\nrouter.get(\"/avatar/:id\", function (req, res, next) {\r\n  // console.log(__dirname + '/../files/avatar/' + req.params.id + '.jpeg')\r\n  const testFolder = __dirname + \"/../files/avatar/\";\r\n  const fs = require(\"fs\");\r\n  fs.readdir(testFolder, (err, files) => {\r\n    try {\r\n      files.forEach((file) => {\r\n        if (file.split(\".\")[0] == req.params.id) {\r\n          console.log(\"Encontrei: \" + file);\r\n          res.sendFile(path.join(__dirname + \"/../files/avatar/\" + file));\r\n        }\r\n      });\r\n    } catch (err) {\r\n      console.log(err);\r\n      res.jsonp(\"Ficheiro não encontrado\");\r\n    }\r\n  });\r\n});\r\n\r\nmodule.exports = router;\r\n"
        }
    ]
}